<div class="admin-container">
  <button (click)="navigateToChat()" class="btn btn-secondary mb-3">⬅ Back to Chat</button>

  <h2>Group & Channel Management</h2>

  <!-- Create Group -->
  <div *ngIf="userRole === 'superadmin'" class="card">
    <h4>Create Group</h4>
    <input [(ngModel)]="groupName" placeholder="Group Name" class="form-control" />
    <input [(ngModel)]="groupDescription" placeholder="Group Description" class="form-control" />
    <button (click)="createGroup()" class="btn btn-primary">➕ Create</button>
  </div>

  <!-- Groups & Channels -->
  <div *ngFor="let group of groups" class="group-card">
    <div class="group-header" (click)="group.expanded = !group.expanded">
      <h3>
        <i class="fa" [ngClass]="group.expanded ? 'fa-caret-down' : 'fa-caret-right'"></i>
        {{ group.name }}
      </h3>
      <span class="desc">{{ group.description }}</span>
    </div>

    <div *ngIf="group.expanded" class="group-content">
      <!-- Channel Management -->
      <h4>Channels</h4>
      <div *ngIf="canManageGroup(group)">
        <input [(ngModel)]="channelName[group._id]" placeholder="Channel Name" class="form-control" />
        <input [(ngModel)]="channelDescription[group._id]" placeholder="Channel Description" class="form-control" />
        <button (click)="createChannel(group._id)" class="btn btn-primary">➕ Add Channel</button>
      </div>

      <ul class="channel-list">
        <li *ngFor="let channel of group.channels" class="channel-item">
          <div class="channel-header">
            <span><strong>{{ channel.name }}</strong> - {{ channel.description }}</span>
            <div class="channel-actions">
              <button (click)="deleteChannel(group._id, channel._id)" class="btn btn-danger btn-sm">🗑</button>
            </div>
          </div>
          <div *ngIf="channel.expanded" class="channel-content">
            <small>Members: {{ channel.members.length }} | Admins: {{ channel.admins.length }}</small>
          </div>
        </li>
      </ul>

      <!-- Member Management Panel -->
      <h4 (click)="group.memberPanelExpanded = !group.memberPanelExpanded" style="cursor: pointer;">
        <i class="fa" [ngClass]="group.memberPanelExpanded ? 'fa-caret-down' : 'fa-caret-right'"></i>
        Member Management
      </h4>

      <div *ngIf="group.memberPanelExpanded" class="member-panel">
        <h5>Admins</h5>
        <ul><li *ngFor="let admin of group.admins">{{ admin.username }}</li></ul>

        <h5>Members</h5>
        <ul><li *ngFor="let member of group.members">{{ member.username }}</li></ul>

        <!-- Add/Remove Controls -->
        <div class="form-group">
          <label>Add Admin</label>
          <select [(ngModel)]="selectedUserIdForAdminForGroup[group._id]" class="form-control">
            <option *ngFor="let user of filterAvailableGroupUsers(group, 'admin')" [value]="user._id">{{ user.username }}</option>
          </select>
          <button (click)="addAdmin(group._id, selectedUserIdForAdminForGroup[group._id])" class="btn btn-warning">Add</button>
        </div>

        <div class="form-group">
          <label>Remove Admin</label>
          <select [(ngModel)]="selectedAdminToRemoveForGroup[group._id]" class="form-control">
            <option *ngFor="let admin of filterRemovableAdmins(group)" [value]="admin._id">{{ admin.username }}</option>
          </select>
          <button (click)="removeAdmin(group._id, selectedAdminToRemoveForGroup[group._id])" class="btn btn-danger">Remove</button>
        </div>

        <div class="form-group">
          <label>Add Member</label>
          <select [(ngModel)]="selectedUserIdForMemberForGroup[group._id]" class="form-control">
            <option *ngFor="let user of filterAvailableGroupUsers(group, 'member')" [value]="user._id">{{ user.username }}</option>
          </select>
          <button (click)="addMember(group._id, selectedUserIdForMemberForGroup[group._id])" class="btn btn-info">Add</button>
        </div>

        <div class="form-group">
          <label>Remove Member</label>
          <select [(ngModel)]="selectedMemberToRemoveForGroup[group._id]" class="form-control">
            <option *ngFor="let member of filterRemovableMembers(group)" [value]="member._id">{{ member.username }}</option>
          </select>
          <button (click)="removeMember(group._id, selectedMemberToRemoveForGroup[group._id])" class="btn btn-danger">Remove</button>
        </div>
      </div>

      <!-- 分隔线，避免 Delete Group 贴太近 -->
      <hr />

      <!-- Delete Group -->
      <button *ngIf="userRole === 'superadmin'" (click)="deleteGroup(group._id)" class="btn btn-danger mt-2">🗑 Delete Group</button>
    </div>
  </div>

  <!-- User Management -->
  <div *ngIf="userRole === 'superadmin'" class="card">
    <h2>User Management</h2>
    <table class="table">
      <thead>
        <tr><th>User</th><th>Roles</th><th>Actions</th></tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers">
          <td>{{ user.username }}</td>
          <td>{{ user.roles.join(', ') }}</td>
          <td>
            <button (click)="changeUserRole(user._id, 'superadmin')" *ngIf="!user.roles.includes('superadmin')" class="btn btn-warning btn-sm">Promote</button>
            <button (click)="changeUserRole(user._id, 'user')" *ngIf="user.roles.includes('superadmin')" class="btn btn-secondary btn-sm">Demote</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
